#!/usr/bin/env ruby

require 'bundler'

CHEFDK_ROOT = File.expand_path("~/oc/chef-dk")

Dir.chdir(CHEFDK_ROOT) do
  Bundler.setup
end

$hax_mode = true

require 'pp'
require 'json'
require 'chef-dk'
require 'chef-dk/policyfile_compiler'

HERE = File.expand_path(Dir.pwd)

policyfile_path = File.join(HERE, "Policyfile.rb")
policyfile_content = IO.read(policyfile_path)

policy = ChefDK::PolicyfileCompiler.evaluate(policyfile_content, policyfile_path)
policy.error!

puts "Expanded run list: " + policy.expanded_run_list.to_s

puts ""

policy.graph_solution.sort.each do |name, version|
  puts "Using #{name} #{version}"
end

puts "Caching Cookbooks"
policy.install

lock_data = policy.lock.to_lock

lockfile_path = File.join(HERE, "Policyfile.lock.json")

File.open(lockfile_path, "w+") do |f|
  f.print(JSON.pretty_generate(lock_data))
end

puts ""

puts "Lockfile written to #{lockfile_path}"

