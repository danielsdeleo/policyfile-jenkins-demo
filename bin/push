#!/usr/bin/env ruby

require 'bundler'

CHEFDK_ROOT = File.expand_path("~/oc/chef-dk")

Dir.chdir(CHEFDK_ROOT) do
  Bundler.setup
end

require 'json'
require 'chef-dk'
require 'chef-dk/authenticated_http'
require 'chef-dk/policyfile_compiler'
require 'chef-dk/policyfile/uploader'

$hax_mode = true

POLICY_GROUP = "demo"

DEBUG_LOADER = false

CHEF_CONFIG_PATH = File.expand_path("etc/zero.rb", Dir.pwd)

Chef::Config.from_file(CHEF_CONFIG_PATH)

# Chef Zero:
Chef::Config.chef_server_url = "http://localhost:8889"

c = Chef::Config

http_client = ChefDK::AuthenticatedHTTP.new(c.chef_server_url, signing_key_filename: c.client_key, client_name: c.node_name)

Chef::Log.init(STDERR)
Chef::Log.level = :info
Chef::Log.level = :debug if DEBUG_LOADER


HERE = File.expand_path(Dir.pwd)

lockfile_path = File.join(HERE, "Policyfile.lock.json")

policy_data = JSON.parse(IO.read(lockfile_path))

storage_config = ChefDK::Policyfile::StorageConfig.new.use_policyfile_lock(lockfile_path)
policy_lock = ChefDK::PolicyfileLock.new(storage_config).build_from_lock_data(policy_data)

ChefDK::Policyfile::Uploader.new(policy_lock, POLICY_GROUP, http_client: http_client).upload

